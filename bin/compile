#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

logger -p user.notice -t "slugc[$$]" "language_pack_java java_compile_start"

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
. $BIN_DIR/common

# parse args
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
GLOBAL_CACHE_DIR=/global_cache

LOGGER_FLAGS=""

export_env_dir $ENV_DIR

JVM_COMMON_BUILDPACK=${JVM_COMMON_BUILDPACK:-https://codon-buildpacks.s3.amazonaws.com/buildpacks/heroku/jvm-common.tgz}
mkdir -p /tmp/jvm-common
curl --silent --location $JVM_COMMON_BUILDPACK | tar xzm -C /tmp/jvm-common --strip-components=1
. /tmp/jvm-common/bin/util
. /tmp/jvm-common/bin/java

KEEP_M2_CACHE="true"

if [ ! -d $CACHE_DIR ]; then
  KEEP_M2_CACHE="false"
elif [ -f $CACHE_DIR/removeM2Cache ]; then
  KEEP_M2_CACHE="false"
fi

if [ "true" == $KEEP_M2_CACHE ]; then
  logger -p user.notice -t "slugc[$$]" "language_pack_java retain_m2_repo"
fi

#create the cache dir if it doesn't exist
mkdir -p $CACHE_DIR

#copy the jdk from cache
if [ -d "$CACHE_DIR/.jdk" ]; then
    cp -r $CACHE_DIR/.jdk $BUILD_DIR/.jdk
fi

# install JDK
javaVersion=$(detect_java_version ${BUILD_DIR})
status_pending "Installing OpenJDK ${javaVersion}"
install_java ${BUILD_DIR} ${javaVersion}
jdk_overlay ${BUILD_DIR}
status_done

#copy the jdk to cache
rm -rf $CACHE_DIR/.jdk
cp -r $BUILD_DIR/.jdk $CACHE_DIR/.jdk

# change to cache dir to install maven
cd $CACHE_DIR

install_maven ${CACHE_DIR} ${BUILD_DIR}

if [ -n "$MAVEN_SETTINGS_PATH" ]; then
  MAVEN_SETTINGS_OPT="-s $MAVEN_SETTINGS_PATH"
elif [ -n "$MAVEN_SETTINGS_URL" ]; then
  status_pending "Installing settings.xml"
  mkdir -p .m2
  curl --silent --max-time 10 --location $MAVEN_SETTINGS_URL --output .m2/settings.xml
  status_done
  MAVEN_SETTINGS_OPT="-s $CACHE_DIR/.m2/settings.xml"
elif [ -f $BUILD_DIR/settings.xml ]; then
  MAVEN_SETTINGS_OPT="-s $BUILD_DIR/settings.xml"
else
  unset MAVEN_SETTINGS_OPT
fi

# symlink from global cache directory
if [ -d $GLOBAL_CACHE_DIR ]; then
  echo "-----> Symlinking global Maven cache"
  for DIR in ".m2" ".maven"; do
    rm -rf $CACHE_DIR/$DIR
    mkdir -p $GLOBAL_CACHE_DIR/$DIR
    ln -s $GLOBAL_CACHE_DIR/$DIR $CACHE_DIR/$DIR
  done
fi

########## NODE.JS STUFF ##########

NPM_DIR="" # can be overridden in .env to specify where package.json/node_modules are
test -f $BUILD_DIR/.env && source $BUILD_DIR/.env

if [ ! -f $BUILD_DIR/$NPM_DIR/package.json ]; then
  echo 'PRO TIP: If you have a package.json in your project, you can define its location in .env file. Just add the line:'
  echo 'export NPM_DIR=subdir'
  echo 'where subdir is a relative path to the directory where package.json is.'
  semver_range=""
else
  # Look in package.json's engines.node field for a semver range
  semver_range=$(cat $BUILD_DIR/$NPM_DIR/package.json | $BIN_DIR/../vendor/jq -r .engines.node)
fi

# Resolve node version using semver.io
node_version=$(curl --silent --get --data-urlencode "range=${semver_range}" https://semver.io/node/resolve)

# Download node from Heroku's S3 mirror of nodejs.org/dist
echo -n "-----> Downloading and installing node v$node_version..."
node_url="http://s3pository.heroku.com/node/v$node_version/node-v$node_version-linux-x64.tar.gz"
curl $node_url -s -o - | tar xzf - -C $BUILD_DIR
echo " done"

# Move node (and npm) into ./vendor and make them executable
mkdir -p $BUILD_DIR/vendor
mv $BUILD_DIR/node-v$node_version-linux-x64 $BUILD_DIR/vendor/node
chmod +x $BUILD_DIR/vendor/node/bin/*
PATH=$PATH:$BUILD_DIR/vendor/node/bin

# symlink from global cache directory
if [ -d $GLOBAL_CACHE_DIR ]; then
  echo "-----> Symlinking global npm cache"
  mkdir -p $GLOBAL_CACHE_DIR/.npm
  rm -rf $BUILD_DIR/.npm
  ln -s $GLOBAL_CACHE_DIR/.npm $BUILD_DIR/.npm
else
  if test -d $CACHE_DIR/.npm; then
    echo "-----> Restoring npm cache directory from cache"
    cp -r $CACHE_DIR/.npm $BUILD_DIR/.npm
  fi
fi

# Run subsequent node/npm commands from the build path
cd $BUILD_DIR/$NPM_DIR

# If node_modules directory is checked into source control then
# rebuild any native deps. Otherwise, restore from the build cache.
if test -d $BUILD_DIR/$NPM_DIR/node_modules; then
  echo "-----> Found existing node_modules directory; skipping cache"
  echo "-----> Rebuilding any native dependencies"
  npm rebuild 2>&1 | sed -u 's/^/      /'
elif test -d $CACHE_DIR/node_modules; then
  echo "-----> Restoring node_modules directory from cache"
  cp -r $CACHE_DIR/node_modules $BUILD_DIR/$NPM_DIR/node_modules

  echo "-----> Pruning cached dependencies not specified in package.json"
  npm prune 2>&1 | sed -u 's/^/      /'
fi

if [ -f "$BUILD_DIR/$NPM_DIR/package.json" ]; then
  echo "-----> Running npm install..."
  npm install --production --userconfig $BUILD_DIR/$NPM_DIR/.npmrc 2>&1 | sed -u 's/^/      /'
fi

########## NODE.JS STUFF ENDS ##########

# change to build dir to run maven
cd $BUILD_DIR

export MAVEN_OPTS="-Xmx1024m"

# build app
maven_profile="staging"
if [ ! -z "$MAVEN_PROFILE" ]; then
  maven_profile="$MAVEN_PROFILE"
fi

BUILDCMD="$CACHE_DIR/.maven/bin/mvn -B"
BUILDCMD="$BUILDCMD -Duser.home=$BUILD_DIR"
BUILDCMD="$BUILDCMD -Dmaven.repo.local=$CACHE_DIR/.m2/repository"
BUILDCMD="$BUILDCMD $MAVEN_SETTINGS_OPT"
BUILDCMD="$BUILDCMD ${MAVEN_CUSTOM_OPTS:-"-DskipTests=true -Dskip.unit.tests"}"
BUILDCMD="$BUILDCMD -P$maven_profile"
BUILDCMD="$BUILDCMD ${MAVEN_CUSTOM_GOALS:-"package"}"

status "executing $BUILDCMD"

$BUILDCMD 2>&1 | sed -u 's/^/       /'

if [ "${PIPESTATUS[*]}" != "0 0" ]; then
  error "Failed to build app with Maven"
fi

# download webapp-runner
if [ -d $GLOBAL_CACHE_DIR/webapp-runner ]; then
    cd $GLOBAL_CACHE_DIR/webapp-runner
    git pull --ff-only 2>&1 >/dev/null
    cd $BUILD_DIR
    cp -r $GLOBAL_CACHE_DIR/webapp-runner .
else
    git clone https://github.com/Vincit/webapp-runner.git 2>&1 | sed -u 's/^/        /'

    if [ -d $GLOBAL_CACHE_DIR ]; then
        cp -r webapp-runner $GLOBAL_CACHE_DIR
    fi
fi

cd webapp-runner

BUILDCMD="$CACHE_DIR/.maven/bin/mvn -B"
BUILDCMD="$BUILDCMD -Duser.home=$BUILD_DIR/webapp-runner"
BUILDCMD="$BUILDCMD -Dmaven.repo.local=$CACHE_DIR/.m2/repository"
BUILDCMD="$BUILDCMD $MAVEN_SETTINGS_OPT"
BUILDCMD="$BUILDCMD -DskipTests=true"
BUILDCMD="$BUILDCMD -f ./pom.xml"
BUILDCMD="$BUILDCMD package"

status "executing $BUILDCMD"

$BUILDCMD 2>&1 | sed -u 's/^/       /'

mkdir -p ../target/dependency
cp target/webapp-runner.jar ../target/dependency/webapp-runner.jar
cd ..
rm -rf webapp-runner

# finalize cache
if [ "false" == $KEEP_M2_CACHE ]; then
  touch $CACHE_DIR/removeM2Cache
fi

echo "-----> Caching node_modules directory for future builds"
rm -rf $CACHE_DIR/node_modules
mkdir -p $CACHE_DIR
test -d $BUILD_DIR/$NPM_DIR/node_modules && cp -r $BUILD_DIR/$NPM_DIR/node_modules $CACHE_DIR/

#echo "-----> Caching bower cache directory for future builds"
#rm -rf $CACHE_DIR/.cache/bower
#mkdir -p $CACHE_DIR/.cache
#test -d /.cache/bower && cp -r /.cache/bower $CACHE_DIR/.cache/

if [ ! -d $GLOBAL_CACHE_DIR ]; then
  echo "-----> Caching npm cache directory for future builds"
  rm -rf $CACHE_DIR/.npm
  mkdir -p $CACHE_DIR/.npm
  test -d $BUILD_DIR/.npm && cp -r $BUILD_DIR/.npm $CACHE_DIR/.npm
fi

echo "-----> Cleaning up cache directories"
rm -rf "$BUILD_DIR/.node-gyp"
rm -rf "$BUILD_DIR/.npm"
rm -rf "/.cache/bower"

logger -p user.notice -t "slugc[$$]" "language_pack_java java_compile_end $LOGGER_FLAGS"
